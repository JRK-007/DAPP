<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Defence Logistics DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
    .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 text-white min-h-screen">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 mb-2">
        üõ°Ô∏è Defence Logistics Management
      </h1>
      <p class="text-gray-400">Blockchain-Powered Asset Tracking System</p>
    </div>
    <!-- Connection Status Bar -->
    <div id="connectionStatus" class="bg-gray-800 rounded-lg p-4 mb-6 flex items-center justify-between flex-wrap gap-4">
      <div id="networkInfo" class="text-sm text-gray-400">Not Connected</div>
      <div id="accountDisplay" class="text-sm"></div>
      <button id="disconnectBtn" class="hidden bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Disconnect</button>
    </div>
    <!-- Login Section -->
    <div id="loginSection" class="bg-gray-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4 text-center">Select Your Role & Connect MetaMask</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button id="loginOfficer" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-lg hover:from-blue-700 hover:to-blue-800 transition transform hover:scale-105 shadow-lg">
          <div class="text-lg font-bold">üëÆ Logistics Officer</div>
          <div class="text-sm opacity-80">Register & Manage Assets</div>
        </button>
        <button id="loginDepot" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-lg hover:from-green-700 hover:to-green-800 transition transform hover:scale-105 shadow-lg">
          <div class="text-lg font-bold">üè≠ Depot Manager</div>
          <div class="text-sm opacity-80">Transfer Assets</div>
        </button>
        <button id="loginAuditor" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-lg hover:from-purple-700 hover:to-purple-800 transition transform hover:scale-105 shadow-lg">
          <div class="text-lg font-bold">üîç Auditor</div>
          <div class="text-sm opacity-80">Audit & Verify</div>
        </button>
      </div>
      <p class="text-xs text-gray-500 text-center mt-4">Auto-connects MetaMask. Must use exact role account from contract.</p>
    </div>
    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- IPFS Upload Section -->
      <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-xl">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <span>üìÅ</span> IPFS Document Upload
        </h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Upload File/Folder (via IPFS Desktop or Direct)</label>
            <input type="file" id="ipfsFile" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer bg-gray-700 rounded-lg" multiple />
            <p class="text-xs text-gray-400 mt-1">Supported: Files/Folders (Max 100MB). For Desktop: Run IPFS daemon first.</p>
          </div>
          <div class="flex gap-3">
            <button id="uploadIPFS" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <span id="uploadBtnText">Upload to IPFS</span>
              <div id="uploadLoader" class="loader hidden"></div>
            </button>
            <button id="openIPFSDesktop" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
              Open IPFS Desktop
            </button>
            <button id="usePublicGateway" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">
              Use Public Gateway
            </button>
          </div>
          <div id="ipfsResult" class="hidden bg-gray-900 rounded-lg p-4 border border-green-500">
            <h3 class="font-bold text-green-400 mb-2">‚úÖ Upload Successful</h3>
            <div class="space-y-2 text-sm">
              <div><span class="text-gray-400">IPFS Hash:</span> <code id="ipfsHashDisplay" class="text-cyan-400 font-mono break-all"></code></div>
              <div><span class="text-gray-400">File Name(s):</span> <span id="ipfsFileName"></span></div>
              <div><span class="text-gray-400">Total Size:</span> <span id="ipfsFileSize"></span></div>
              <div><span class="text-gray-400">File Type(s):</span> <span id="ipfsFileType"></span></div>
              <div><span class="text-gray-400">Upload Time:</span> <span id="ipfsUploadTime"></span></div>
              <div class="flex gap-2 mt-3">
                <a id="ipfsGatewayLink" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 underline text-sm">View on IPFS Gateway ‚Üí</a>
                <button id="copyHashBtn" class="text-gray-400 hover:text-white text-sm">üìã Copy Hash</button>
              </div>
            </div>
          </div>
          <div id="ipfsError" class="hidden bg-red-900 bg-opacity-30 border border-red-500 rounded-lg p-4 text-red-300 text-sm"></div>
        </div>
      </div>
      <!-- Role-Specific Actions -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Logistics Officer Actions -->
        <div id="officerActions" class="hidden bg-gray-800 rounded-lg p-6 shadow-xl">
          <h3 class="text-xl font-bold mb-4 text-blue-400">üëÆ Register New Asset</h3>
          <div class="space-y-3">
            <input id="assetId" type="number" placeholder="Asset ID (e.g., 1001)" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <input id="assetName" placeholder="Asset Name (e.g., M16 Rifle)" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <input id="supplierName" placeholder="Supplier Name" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <input id="ipfsHashInput" placeholder="IPFS Hash (auto-fills from upload)" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <textarea id="note" placeholder="Registration Notes" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="2"></textarea>
            <button id="registerBtn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold transition flex items-center justify-center gap-2 disabled:opacity-50">
              <span id="registerBtnText">Register Asset</span>
              <div id="registerLoader" class="loader hidden"></div>
            </button>
          </div>
        </div>
        <!-- Depot Manager Actions -->
        <div id="depotActions" class="hidden bg-gray-800 rounded-lg p-6 shadow-xl">
          <h3 class="text-xl font-bold mb-4 text-green-400">üè≠ Transfer Asset</h3>
          <div class="space-y-3">
            <input id="transferId" type="number" placeholder="Asset ID" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
            <input id="newHolder" placeholder="New Holder Address (0x...)" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
            <select id="transferStatus" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
              <option value="">Select Status</option>
              <option value="In Transit">In Transit</option>
              <option value="Delivered">Delivered</option>
              <option value="In Storage">In Storage</option>
              <option value="Under Maintenance">Under Maintenance</option>
              <option value="Deployed">Deployed</option>
            </select>
            <textarea id="transferNote" placeholder="Transfer Notes" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" rows="2"></textarea>
            <button id="transferBtn" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-semibold transition flex items-center justify-center gap-2 disabled:opacity-50">
              <span id="transferBtnText">Transfer Asset</span>
              <div id="transferLoader" class="loader hidden"></div>
            </button>
          </div>
        </div>
        <!-- Auditor Actions -->
        <div id="auditorActions" class="hidden bg-gray-800 rounded-lg p-6 shadow-xl">
          <h3 class="text-xl font-bold mb-4 text-purple-400">üîç Audit Asset</h3>
          <div class="space-y-3">
            <input id="auditId" type="number" placeholder="Asset ID" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            <textarea id="auditNote" placeholder="Audit Findings & Notes" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" rows="3"></textarea>
            <button id="auditBtn" class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 font-semibold transition flex items-center justify-center gap-2 disabled:opacity-50">
              <span id="auditBtnText">Submit Audit</span>
              <div id="auditLoader" class="loader hidden"></div>
            </button>
          </div>
        </div>
        <!-- View Asset Details -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl col-span-1 lg:col-span-2">
          <h3 class="text-xl font-bold mb-4">üîé View Asset Details</h3>
          <div class="space-y-3">
            <input id="viewId" type="number" placeholder="Enter Asset ID" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-gray-500 outline-none">
            <button id="viewBtn" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg hover:bg-gray-600 font-semibold transition flex items-center justify-center gap-2">
              <span>Get Details</span>
              <div id="viewLoader" class="loader hidden"></div>
            </button>
          </div>
        </div>
      </div>
      <!-- Asset Details Display -->
      <div id="assetDetailsSection" class="hidden bg-gray-800 rounded-lg p-6 shadow-xl mb-6">
        <h3 class="text-xl font-bold mb-4">Asset Information</h3>
        <div id="assetDetails" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"></div>
        <div id="assetHistorySection" class="hidden mt-6">
          <h4 class="text-lg font-bold mb-3 text-cyan-400">üìú Status History & Audit Trail</h4>
          <div id="assetHistory" class="space-y-2"></div>
        </div>
      </div>
      <!-- Event Logs -->
      <div class="bg-gray-800 rounded-lg p-6 shadow-xl mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">üìã Recent Events</h3>
          <button id="refreshEvents" class="bg-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-600">Refresh</button>
        </div>
        <div id="eventLogs" class="space-y-2 max-h-96 overflow-y-auto"></div>
      </div>
      <!-- All Assets List -->
      <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">üì¶ All Assets</h3>
          <input id="searchAsset" type="number" placeholder="Search Asset ID..." class="bg-gray-700 px-3 py-1 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div id="assetsList" class="space-y-2">
          <p class="text-gray-400 text-center py-4">No assets to display</p>
        </div>
      </div>
    </div>
    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 border-l-4 rounded-lg p-4 shadow-2xl hidden max-w-md z-50"></div>
  </div>
  <script>
    let web3, contract, account, currentRole;
    const CONTRACT_ADDRESS = "0xYourDeployedContractAddressHere"; // REPLACE WITH DEPLOYED ADDRESS FROM REMIX
    const PINATA_API_KEY = "YOUR_PINATA_API_KEY"; // GET FREE FROM pinata.cloud
    const PINATA_SECRET = "YOUR_PINATA_SECRET_API_KEY";

    // Full ABI
    const CONTRACT_ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetId","type":"uint256"},{"indexed":false,"internalType":"address","name":"auditor","type":"address"},{"indexed":false,"internalType":"string","name":"auditNote","type":"string"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"AssetAudited","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":false,"internalType":"string","name":"supplier","type":"string"},{"indexed":false,"internalType":"string","name":"ipfsHash","type":"string"},{"indexed":false,"internalType":"address","name":"holder","type":"address"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"AssetRegistered","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetId","type":"uint256"},{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"newStatus","type":"string"},{"indexed":false,"internalType":"string","name":"note","type":"string"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"AssetTransferred","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"assetId","type":"uint256"},{"indexed":false,"internalType":"string","name":"oldSupplier","type":"string"},{"indexed":false,"internalType":"string","name":"newSupplier","type":"string"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"SupplierChanged","type":"event"},
      {"inputs":[],"name":"agencyAuditor","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"assetRecords","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"supplier","type":"string"},{"internalType":"address","name":"currentHolder","type":"address"},{"internalType":"uint256","name":"registeredAt","type":"uint256"},{"internalType":"string","name":"ipfsHash","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"},{"internalType":"string","name":"note","type":"string"}],"name":"auditAsset","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"},{"internalType":"string","name":"newSupplier","type":"string"}],"name":"changeSupplier","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"depotManager","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"}],"name":"getAsset","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"}],"name":"getAssetHistory","outputs":[{"components":[{"internalType":"string","name":"status","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"note","type":"string"}],"internalType":"struct DefenceLogistics.StatusEvent[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"logisticsOfficer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"supplier","type":"string"},{"internalType":"string","name":"ipfsHash","type":"string"},{"internalType":"string","name":"note","type":"string"}],"name":"registerAsset","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"assetId","type":"uint256"},{"internalType":"address","name":"newHolder","type":"address"},{"internalType":"string","name":"newStatus","type":"string"},{"internalType":"string","name":"note","type":"string"}],"name":"transferAsset","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let registeredAssets = new Set();
    let usePublicIPFS = false;

    // Utility Functions
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const colors = {
        success: 'border-green-500 bg-green-900',
        error: 'border-red-500 bg-red-900',
        info: 'border-blue-500 bg-blue-900',
        warning: 'border-yellow-500 bg-yellow-900'
      };
      toast.className = `fixed bottom-4 right-4 ${colors[type]} border-l-4 rounded-lg p-4 shadow-2xl max-w-md z-50`;
      toast.innerHTML = `<div>${message}</div>`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 5000);
    }

    function setLoading(btnId, loaderId, loading, text = '') {
      const btn = document.getElementById(btnId);
      const loader = document.getElementById(loaderId);
      const textEl = document.getElementById(btnId.replace('Btn', 'BtnText') || document.getElementById(btnId + 'Text'));
      btn.disabled = loading;
      if (loading) {
        loader.classList.remove('hidden');
        if (textEl) textEl.textContent = text || 'Processing...';
      } else {
        loader.classList.add('hidden');
        if (textEl) textEl.textContent = text;
      }
    }

    function formatAddress(addr) {
      return addr ? `${addr.slice(0, 6)}...${addr.slice(-4)}` : '';
    }

    function formatDate(timestamp) {
      return new Date(Number(timestamp) * 1000).toLocaleString();
    }

    // MetaMask Auto-Connect & Role Validation
    async function connectMetaMask(selectedRole) {
      if (!window.ethereum) {
        showToast('Install MetaMask first. No wallet, no blockchain.', 'error');
        return;
      }
      try {
        // Auto-request accounts
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        web3 = new Web3(window.ethereum);
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];

        // Check network (Sepolia)
        const chainId = await web3.eth.getChainId();
        if (chainId !== 11155111) { // Sepolia chain ID
          showToast('Switch to Sepolia testnet in MetaMask.', 'error');
          return;
        }

        // Init contract
        if (!contract) contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

        // Fetch role addresses from contract
        const officerAddr = await contract.methods.logisticsOfficer().call();
        const depotAddr = await contract.methods.depotManager().call();
        const auditorAddr = await contract.methods.agencyAuditor().call();

        // Validate account matches selected role
        let role = null;
        if (account.toLowerCase() === officerAddr.toLowerCase() && selectedRole === 'Logistics Officer') {
          role = 'Logistics Officer';
        } else if (account.toLowerCase() === depotAddr.toLowerCase() && selectedRole === 'Depot Manager') {
          role = 'Depot Manager';
        } else if (account.toLowerCase() === auditorAddr.toLowerCase() && selectedRole === 'Auditor') {
          role = 'Auditor';
        }

        if (!role) {
          showToast(`Wrong account for ${selectedRole}. Use exact: ${selectedRole === 'Logistics Officer' ? officerAddr : selectedRole === 'Depot Manager' ? depotAddr : auditorAddr}`, 'error');
          return;
        }

        currentRole = role;
        const network = await web3.eth.net.getNetworkType();

        document.getElementById("networkInfo").innerHTML = `<span class="text-green-400">‚óè Connected</span> | Network: ${network} | Chain: ${chainId}`;
        document.getElementById("accountDisplay").innerHTML = `<span class="text-gray-400">Role:</span> <span class="font-bold text-${role === 'Logistics Officer' ? 'blue' : role === 'Depot Manager' ? 'green' : 'purple'}-400">${role}</span> | <span class="text-gray-400">Account:</span> <code class="text-cyan-400">${formatAddress(account)}</code>`;

        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        document.getElementById("disconnectBtn").classList.remove("hidden");

        // Show role actions
        if (role === "Logistics Officer") document.getElementById("officerActions").classList.remove("hidden");
        if (role === "Depot Manager") document.getElementById("depotActions").classList.remove("hidden");
        if (role === "Auditor") document.getElementById("auditorActions").classList.remove("hidden");

        showToast(`Connected as ${role}. Actions unlocked.`, 'success');
        loadEventLogs();
        loadAllAssets(); // Initial load
      } catch (error) {
        console.error(error);
        showToast(`Connection failed: ${error.message}. Check MetaMask.`, 'error');
      }
    }

    // Disconnect
    document.getElementById("disconnectBtn").onclick = () => location.reload();

    // Role Buttons
    document.getElementById("loginOfficer").onclick = () => connectMetaMask("Logistics Officer");
    document.getElementById("loginDepot").onclick = () => connectMetaMask("Depot Manager");
    document.getElementById("loginAuditor").onclick = () => connectMetaMask("Auditor");

    // IPFS Functions
    document.getElementById("openIPFSDesktop").onclick = () => {
      // Attempts to open IPFS Desktop via protocol (if installed)
      window.location.href = 'ipfs://localhost'; // Fallback to local if handler exists
      showToast('Opening IPFS Desktop... Upload there, then use file input here for hash.', 'info');
    };

    document.getElementById("usePublicGateway").onclick = () => {
      usePublicIPFS = !usePublicIPFS;
      const btn = document.getElementById("usePublicGateway");
      btn.textContent = usePublicIPFS ? "Using Public Gateway ‚úì" : "Use Public Gateway";
      btn.className = usePublicIPFS ? "bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm" : "bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm";
      showToast(usePublicIPFS ? "Switched to Pinata (add your keys in JS)" : "Switched to Local IPFS (run ipfs daemon)", 'info');
    };

    document.getElementById("uploadIPFS").onclick = async () => {
      const fileInput = document.getElementById("ipfsFile");
      if (!fileInput.files.length) {
        showToast("Select file(s)/folder first.", 'warning');
        return;
      }
      const files = Array.from(fileInput.files);
      const totalSize = files.reduce((acc, f) => acc + f.size, 0);
      if (totalSize > 100 * 1024 * 1024) {
        showToast("Total size >100MB.", 'error');
        return;
      }
      setLoading('uploadIPFS', 'uploadLoader', true, 'Uploading...');
      document.getElementById('ipfsResult').classList.add('hidden');
      document.getElementById('ipfsError').classList.add('hidden');
      try {
        let hash;
        const startTime = Date.now();
        if (usePublicIPFS) {
          // Pinata (multi-file via folder simulation)
          const formData = new FormData();
          files.forEach(f => formData.append('file', f));
          const response = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
            method: 'POST',
            body: formData,
            headers: {
              'pinata_api_key': PINATA_API_KEY,
              'pinata_secret_api_key': PINATA_SECRET
            }
          });
          if (!response.ok) throw new Error('Pinata failed. Check keys.');
          const data = await response.json();
          hash = data.IpfsHash;
        } else {
          // Local IPFS (requires daemon running at http://127.0.0.1:5001)
          const { create } = await import('ipfs-http-client'); // Dynamic import for browser compat
          const ipfs = create({ url: 'http://127.0.0.1:5001' });
          const results = [];
          for (const file of files) {
            const result = await ipfs.add(file);
            results.push(result.path);
          }
          hash = results[0].cid.toString(); // Use first for single, or wrap in dir for multi
        }
        const endTime = Date.now();
        // Display details
        document.getElementById('ipfsHashDisplay').textContent = hash;
        document.getElementById('ipfsFileName').textContent = files.map(f => f.name).join(', ');
        document.getElementById('ipfsFileSize').textContent = `${(totalSize / 1024 / 1024).toFixed(2)} MB`;
        document.getElementById('ipfsFileType').textContent = [...new Set(files.map(f => f.type || 'Unknown'))].join(', ');
        document.getElementById('ipfsUploadTime').textContent = `${((endTime - startTime) / 1000).toFixed(1)}s`;
        document.getElementById('ipfsGatewayLink').href = `https://ipfs.io/ipfs/${hash}`;
        document.getElementById('ipfsHashInput').value = hash; // Auto-fill for register
        document.getElementById('ipfsResult').classList.remove('hidden');
        showToast('Upload done. Hash ready for contract.', 'success');
      } catch (error) {
        console.error(error);
        document.getElementById('ipfsError').innerHTML = `Error: ${error.message}. Local: Run 'ipfs daemon'. Public: Add Pinata keys.`;
        document.getElementById('ipfsError').classList.remove('hidden');
        showToast('Upload failed: ' + error.message, 'error');
      } finally {
        setLoading('uploadIPFS', 'uploadLoader', false, 'Upload to IPFS');
      }
    };

    document.getElementById("copyHashBtn").onclick = () => {
      const hash = document.getElementById('ipfsHashDisplay').textContent;
      navigator.clipboard.writeText(hash).then(() => showToast('Hash copied.', 'success'));
    };

    // Register Asset (Officer only, validated)
    document.getElementById("registerBtn").onclick = async () => {
      const id = parseInt(document.getElementById("assetId").value);
      const name = document.getElementById("assetName").value.trim();
      const supplier = document.getElementById("supplierName").value.trim();
      const ipfsHash = document.getElementById("ipfsHashInput").value.trim();
      const note = document.getElementById("note").value.trim();
      if (!id || !name || !supplier || !ipfsHash) {
        showToast('Fill all fields, including IPFS hash.', 'warning');
        return;
      }
      setLoading('registerBtn', 'registerLoader', true);
      try {
        const tx = await contract.methods.registerAsset(id, name, supplier, ipfsHash, note).send({ from: account });
        showToast(`Asset ${id} registered. Tx: ${formatAddress(tx.transactionHash)}`, 'success');
        registeredAssets.add(id);
        // Clear form
        document.getElementById("assetId").value =